// ============================================
// COPIAR ESTA FUNCI√ìN A login.js
// ============================================

// 1. AGREGAR ESTA CONSTANTE AL INICIO DEL ARCHIVO (despu√©s de DOMContentLoaded)
const EMAIL_SERVER_URL = 'http://localhost:3000';
// En producci√≥n cambia a: https://tu-servidor.com

// 2. REEMPLAZAR LA FUNCI√ìN recuperarContrasena POR ESTA:

async function recuperarContrasenaConGmail(email) {
    const recoveryBtn = document.getElementById('recoveryBtn');
    const btnText = recoveryBtn.querySelector('.btn-text');
    const btnLoader = recoveryBtn.querySelector('.btn-loader');
    const recoveryError = document.getElementById('recoveryError');
    const recoveryMessage = document.getElementById('recoveryMessage');
    
    try {
        // Mostrar loader
        recoveryBtn.disabled = true;
        btnText.style.display = 'none';
        btnLoader.style.display = 'inline-flex';
        
        console.log('üìß Solicitando recuperaci√≥n de contrase√±a para:', email);
        
        // Llamar a NUESTRO servidor de correos
        const response = await fetch(`${EMAIL_SERVER_URL}/send-recovery-email`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ email })
        });

        const data = await response.json();

        if (!response.ok) {
            console.error('Error del servidor:', data);
            
            if (response.status === 404) {
                recoveryError.textContent = 'No existe una cuenta con este correo electr√≥nico.';
            } else {
                recoveryError.textContent = data.error || 'Error al procesar la solicitud. Intenta m√°s tarde.';
            }
            return;
        }
        
        console.log('‚úÖ Correo enviado exitosamente');
        
        // Mostrar mensaje de √©xito
        recoveryMessage.innerHTML = `
            <div class="recovery-success">
                <div class="success-icon">‚úâÔ∏è</div>
                <h3>¬°Correo enviado exitosamente!</h3>
                <p>Hemos enviado tu contrase√±a a <strong>${email}</strong></p>
                <p class="recovery-note">
                    Revisa tu bandeja de entrada. Si no lo ves, revisa la carpeta de spam.
                    <br><br>
                    <strong>‚ö†Ô∏è Importante:</strong> Por seguridad, te recomendamos cambiar tu contrase√±a despu√©s de iniciar sesi√≥n.
                </p>
                <div class="recovery-timer">
                    Este mensaje se cerrar√° en <span id="countdown">10</span> segundos
                </div>
            </div>
        `;
        
        // Countdown y cerrar modal
        let segundos = 10;
        const countdownElement = document.getElementById('countdown');
        const interval = setInterval(() => {
            segundos--;
            if (countdownElement) {
                countdownElement.textContent = segundos;
            }
            if (segundos <= 0) {
                clearInterval(interval);
                document.getElementById('recoveryModal').style.display = 'none';
            }
        }, 1000);
        
    } catch (error) {
        console.error('‚ùå Error al conectar con el servidor:', error);
        
        // Verificar si el servidor est√° ca√≠do
        if (error.message.includes('Failed to fetch')) {
            recoveryError.textContent = '‚ö†Ô∏è No se puede conectar con el servidor de correos. Verifica que est√© activo en http://localhost:3000';
        } else {
            recoveryError.textContent = 'Error al procesar la solicitud. Verifica tu conexi√≥n.';
        }
    } finally {
        recoveryBtn.disabled = false;
        btnText.style.display = 'inline';
        btnLoader.style.display = 'none';
    }
}

// 3. CAMBIAR EL EVENTO DEL FORMULARIO DE RECUPERACI√ìN
// Buscar esta l√≠nea:
//     await recuperarContrasena(email);
// Cambiarla por:
//     await recuperarContrasenaConGmail(email);
